# K-Admin: 高性能通用型后台管理系统需求规格说明书 (PRD)

## 1. 项目概述 (Project Overview)

**项目名称**: K-Admin
**核心目标**: 构建一个基于 Go + React 的现代化、模块化、高可扩展的后台管理框架。
**设计理念**:

* **KISS 原则 (Keep It Simple, Stupid)**: 拒绝臃肿，没有无用的代码。每一行代码都有其存在的意义。
* **极致模块化**: 后端采用类似于 Domain-Driven Design (DDD) 的模块化分层，前端采用原子化组件设计。
* **开发提效**: 内置强大的可视化数据库管理与代码生成器，实现"从数据库设计到前后端代码落地"的分钟级开发体验。
* **安全严谨**: 细粒度的 RBAC 权限控制（菜单级、按钮级、API 级）。

---

## 2. 技术栈架构 (Tech Stack)

### 2.1 前端架构 (Frontend)

* **核心框架**: React 18+ (Hooks First)
* **构建工具**: Vite (追求极致的开发热更新速度)
* **UI 组件库**: Ant Design 5.0+ (使用 App 包裹组件，利用 Token 系统定制主题，支持暗黑模式)
* **状态管理**: Zustand (轻量级，不仅 Redux 的繁琐，适合 Go 开发者思维)
* **路由管理**: React-Router v6 (Data API)
* **网络请求**: Axios (封装拦截器，处理 JWT 刷新与统一响应)
* **图标库**: Lucide-React (更现代) 或 AntD Icons
* **工具库**: Lodash, Dayjs, ahooks

### 2.2 后端架构 (Backend)

* **核心语言**: Go (Golang) 1.22+
* **Web 框架**: Gin (高性能路由)
* **ORM 框架**: Gorm (配合 Gen 工具可实现更强的类型安全)
* **数据库**: MySQL 8.0+ (架构设计需预留 PostgreSQL 接口)
* **鉴权中间件**: JWT-Go (双 Token 机制: Access + Refresh)
* **权限控制**: Casbin (用于处理复杂的 RBAC 策略，支持 RESTful 路径匹配)
* **配置管理**: Viper (支持 YAML/JSON/Env 注入)
* **日志系统**: Zap + Lumberjack (日志切割与归档)
* **API 文档**: Swagger (Swag)

---

## 3. 系统架构设计 (System Architecture)

### 3.1 目录结构规范

#### 后端 (Golang - `k-admin-server`)

* **api**: API 入口层 (Controller)
* **v1**: API 版本控制
* **system**: 系统基础接口 (Login, User, Menu)
* **tools**: 工具类接口 (DB, Gen)




* **config**: 配置文件结构体定义
* **core**: 核心组件 (Server启动, Viper加载, Zap初始化)
* **global**: 全局对象 (GVA_DB, GVA_REDIS, GVA_CONFIG)
* **middleware**: 中间件 (JWT, Casbin, CORS, RateLimit, Recovery)
* **model**: 数据库模型 & 结构体
* **common**: 通用模型 (ID, CreatedAt, UnifiedResponse)
* **system**: 系统基础表 (SysUser, SysRole, SysMenu)


* **resource**: 静态资源 (代码生成模版/Excel模版)
* **template**: K-Admin 代码生成器模版 (.txt/.tpl)


* **router**: 路由层 (负责注册 Gin 路由)
* **service**: 业务逻辑层 (Service)
* **utils**: 工具箱 (JWT, Hash, File, Validator)
* **main.go**: 程序入口

#### 前端 (React - `k-admin-web`)

* **src**
* **api**: API 接口定义 (按模块划分, e.g., user.ts, db.ts)
* **assets**: 静态资源 (Logo, Images)
* **components**: 公共组件
* **Auth**: 权限相关 (AuthButton, AuthGuard)
* **ProTable**: 封装的高级表格 (集成搜索、分页、刷新)
* **Theme**: 主题切换


* **hooks**: 自定义 Hooks (useAuth, useTheme, useDebounce)
* **layout**: 布局组件 (Sidebar, Header, Tabs, Footer)
* **router**: 路由配置 (包含动态路由守卫逻辑)
* **store**: 状态管理 (useUserStore, useAppStore)
* **utils**: 工具 (Request, Storage, Format)
* **views**: 页面视图
* **dashboard**: 仪表盘
* **system**: 系统管理 (User, Role, Menu)
* **tools**: 开发者工具 (DB Manager, Code Generator)





---

## 4. 核心功能模块详解 (Functional Requirements)

### 4.1 统一响应模型 (Unified Response)

**目标**: 无论成功与否，后端返回的数据结构必须高度一致，便于前端拦截器处理。

**JSON 结构**:

```json
{
  "code": 0,            // 业务状态码: 0 成功, 7 错误 (参考 Go 习惯或自定义)
  "data": { ... },      // 数据载体
  "msg": "操作成功"       // 提示信息
}

```

* **后端封装**: `response.Ok(c, data)`, `response.Fail(c, msg)`, `response.OkWithDetailed(c, data, msg)`。

### 4.2 鉴权与 JWT 管理 (Authentication)

* **登录流程**: 账号密码/验证码 -> 后端验证 -> 生成 AccessToken (15min) + RefreshToken (7day)。
* **JWT 策略**:
* 前端存储 Token 于 LocalStorage。
* Axios 拦截器：检测 `401 Unauthorized`，自动使用 RefreshToken 换取新 AccessToken 并重发原请求（无感刷新）。
* **强制下线 (Kick out)**: 配合 Redis 黑名单机制，管理员可让特定 Token 立即失效。



### 4.3 多级权限管理 (RBAC & Casbin)

这是 K-Admin 的核心安全防线，分为三个维度：

1. **菜单/路由级权限 (Page Level)**:
* **后端**: `sys_menus` 表存储菜单树。字段包含 `component` (React 组件路径, 如 `views/system/user/index`)。
* **API**: `/menu/getMenu` 返回当前用户角色对应的菜单树。
* **前端**: 登录后获取菜单树 -> 递归映射为 React Router 路由表 -> 动态挂载 (React Router v6 `useRoutes` 或 `createBrowserRouter`)。
* **侧边栏**: 根据菜单树自动递归渲染 AntD Menu 组件。


2. **API 级权限 (Data Security)**:
* 使用 **Casbin** 中间件。
* 策略存储在数据库 `sys_casbin_rules` 中。
* 格式: `p, role_admin, /api/v1/user, POST` (角色 admin 可以 POST 访问 /api/v1/user)。
* Gin 中间件拦截请求，提取 `(sub=role_id, obj=request_uri, act=request_method)` 进行校验。


3. **按钮级权限 (Element Level)**:
* **需求**: 用户能看页面，但不能点 "删除" 按钮。
* **实现**: 前端封装 `<AuthButton perm="user:delete">删除</AuthButton>` 组件。
* **逻辑**: 组件内部通过 `useUserStore` 检查当前用户的 `permissions` 数组，无权则不渲染或渲染为 `disabled`。



### 4.4 可视化数据库管理 (DB Inspector & SQL Console)

**目标**: 在生产/开发环境直接操作数据库，类似网页版 Navicat，作为代码生成器的前置步骤。

* **多库连接**: 支持配置多个数据源，动态切换 `gorm.DB` 实例。
* **可视化表管理**:
* 展示当前库所有表名。
* 查看表结构 (Column, Type, Comment, Key)。
* **数据浏览**: 动态渲染 AntD Table，支持简单的增删改查 (CRUD)。


* **SQL 执行器 (SQL Console)**:
* 集成 **Monaco Editor** (VS Code 编辑器内核) 输入 SQL。
* **后端安全**:
* 必须设置白名单或 "Read-Only" 模式开关。
* 禁止执行 `DROP DATABASE`, `TRUNCATE` 等高危命令 (除非超级管理员二次确认+输入密码)。





### 4.5 K-Admin 智能化代码生成器 (Auto Code Generator)

**核心逻辑**: 数据库表结构 -> 结构化元数据 -> `text/template` -> 生成文件。

1. **输入源**:
* 从 "可视化数据库管理" 模块中选择一张表 (例如 `k_orders`)。


2. **配置项**:
* **Struct Name**: `Order`
* **Package Name**: `order`
* **Frontend Path**: `views/business/order`
* **Fields Mapping**: 自动读取表字段，允许用户修正 JSON Tag 和 Gorm Tag。


3. **生成内容**:
* **Backend**:
* `model/order.go` (Gorm Struct)
* `service/order.go` (CRUD Logic)
* `api/order.go` (Gin Controller)
* `router/order.go` (Router Registration)


* **Frontend**:
* `api/order.ts` (Axios Request Definitions)
* `types/order.ts` (TypeScript Interfaces)
* `index.tsx` (Table Page: Search, Table, Pagination)
* `components/OrderModal.tsx` (Form Modal: Create/Edit)




4. **高级特性**:
* **自动建表**: 允许用户在界面定义字段 (名称、类型、注释)，后端调用 `gorm.AutoMigrate` 建表，然后再生成代码。
* **预览模式**: 生成前先预览代码内容。



---

## 5. 数据库设计摘要 (Database Schema)

### 5.1 用户表 (sys_users)

| 字段 | 类型 | 说明 |
| --- | --- | --- |
| id | uint | 主键 |
| username | varchar | 登录名 |
| password | varchar | 加密密码 (Bcrypt) |
| header_img | varchar | 头像地址 |
| role_id | uint | 主角色ID |
| active | bool | 状态 (启用/禁用) |

### 5.2 角色表 (sys_roles)

| 字段 | 类型 | 说明 |
| --- | --- | --- |
| id | uint | 主键 |
| role_name | varchar | 角色名 (e.g. 超级管理员) |
| role_key | varchar | 角色标识 (e.g. admin) |
| data_scope | varchar | 数据权限范围 (全部/本级/自定义) |

### 5.3 菜单表 (sys_menus)

| 字段 | 类型 | 说明 |
| --- | --- | --- |
| id | uint | 主键 |
| parent_id | uint | 父菜单ID |
| path | varchar | 路由路径 (/system/user) |
| name | varchar | 路由名称 (SystemUser - 用于 KeepAlive) |
| component | varchar | 前端组件路径 (views/system/user/index) |
| sort | int | 排序 |
| meta | json | 元数据 (icon, title, hidden, keepAlive) |
| btn_perms | json | 该菜单下的按钮权限标识集合 |

---

## 6. 开发与交互体验要求 (UX/DX Requirements)

1. **Loading 状态自动化**: 前端封装 Hook，请求发起自动开启 Table Loading，结束自动关闭，避免手动维护 `setLoading(true/false)`。
2. **错误处理**: 后端 Panic 捕获中间件，防止服务崩溃；前端全局 Error Boundary。
3. **Keep-Alive**: 前端实现页签 (Tabs) 缓存，切换菜单时不丢失表单填写的数据。
4. **一键部署**: 提供 `Dockerfile` 和 `docker-compose.yml`，支持前后端分离部署或 Nginx 统一反代。